
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS RECEIVER WebP</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { background: #000; color: #00ff41; font-family: sans-serif; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        #v-container { position: relative; width: 100%; max-width: 500px; line-height: 0; border: 1px solid #333; border-radius: 15px; overflow: hidden; background: #000; box-shadow: 0 0 30px rgba(0,255,65,0.2); }
        video { width: 100%; aspect-ratio: 16/9; }
        .fs-btn { position: absolute; bottom: 15px; right: 15px; background: #00ff41; color: #000; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; font-size: 12px; z-index: 10; opacity: 0.8; }
        .ui-box { width: 100%; max-width: 500px; margin-top: 20px; }
        textarea { width: 100%; height: 90px; background: #111; color: #00ff41; border: 1px solid #333; border-radius: 10px; padding: 12px; font-size: 11px; box-sizing: border-box; margin-bottom: 10px; outline: none; }
        button { width: 100%; padding: 16px; background: transparent; color: #00ff41; border: 1px solid #00ff41; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { background: #00ff41; color: #000; }
        #status { font-size: 11px; margin-bottom: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

<div id="status">LINK STATUS: STANDBY</div>

<div id="v-container">
    <video id="v" autoplay playsinline muted></video>
    <button class="fs-btn" id="fs-btn">FULLSCREEN</button>
</div>

<div class="ui-box">
    <textarea id="remote-sdp" placeholder="1. PCのコードをここに貼り付け"></textarea>
    <button onclick="startGuest()">視聴コード生成</button>

    <div id="guest-box" style="display:none; margin-top:15px;">
        <textarea id="local-sdp" readonly placeholder="生成されたコード"></textarea>
        <button onclick="copyCode()" style="background:#00ff41; color:#000;">コピーしてPCに送信</button>
    </div>
</div>

<script>
    let pc;
    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
    const video = document.getElementById('v');

    async function startGuest() {
        const val = document.getElementById('remote-sdp').value.trim();
        if(!val) return;

        pc = new RTCPeerConnection(config);
        
        // 映像が途切れないための強制再生
        pc.ontrack = e => {
            if (video.srcObject !== e.streams[0]) {
                video.srcObject = e.streams[0];
                video.play().catch(() => {
                    // 自動再生に失敗した場合はクリックを促す
                    document.getElementById('status').innerText = "TAP VIDEO TO START";
                });
                document.getElementById('status').innerText = "LINK ESTABLISHED";
            }
        };

        const sdpText = decodeURIComponent(escape(atob(val)));
        await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: sdpText }));

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        pc.onicecandidate = e => {
            if (!e.candidate) {
                document.getElementById('local-sdp').value = btoa(unescape(encodeURIComponent(pc.localDescription.sdp)));
                document.getElementById('guest-box').style.display = 'block';
            }
        };
    }

    // スマホ全画面対応
    document.getElementById('fs-btn').addEventListener('click', () => {
        const container = document.getElementById('v-container');
        if (!document.fullscreenElement) {
            if (container.requestFullscreen) container.requestFullscreen();
            else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen();
            
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(() => {});
            }
        } else {
            document.exitFullscreen();
        }
    });

    function copyCode() {
        document.getElementById('local-sdp').select();
        document.execCommand('copy');
    }
</script>
</body>
</html>
